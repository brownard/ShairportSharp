using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using ShairportSharp.Sap;
using ShairportSharp.Helpers;

namespace Tests
{
    [TestClass]
    public class SapTests
    {
        static readonly string[] Challenge1 = 
        { 
            "46504C590301010000000004020002BB",
            "46504C590301010000000004020003BB"
        };

        static readonly string[] Response1 =
        {
            "46504C5903010200000000820202F7A82C811AA21744B76837D8A344EF26C54FDBFDF716C5330828EB8DC928400961FCCF2F90B2E30F2C3F1D6DCC475528B8F4198D7D73ECCEA9AF5E13B7DE90ACFDDEA8F22AE19F4F1317C0951CB77633F82127C5C19EBDB3B2A4A567BDED5CFF4D7ED35F12E60EA91939A0210E065CF8C71A2983375EACE5653C072A68005AEC",
            "46504C5903010200000000820203879F7A3D3CE5A4C5DB51176FA886BABD9CA307A9626D8BBEEE2EC31A2EFDEC3D9F5714833E2B3FFE6044B09A8C9946DFDA0BCEB86AF01D27757F2F37AB366D138C0BD89B792D35695884089618460D4888EE0D09ED829B61A94F41E0F4CBA1D49A2009130A64336CE44A030BCA9960B9BA91511DB91F4A3DF46F246DE2171F98"
        };

        static readonly string[] Challenge2 = 
        { 
            "46504C590301030000000098028F1A9CB9FFB789A50D48FF132279AE897EFFFBC2E82B941B2B04E9D31BBCCF3AD4B3191F137D267C229E07DC28FCC8D292CF9599D67040298E2F34C49B7D31F4188217A438F3760A659B6E0E3A9F546D3CA1A7725ABA940357D1F911D1B7E20005426EBCA74EC49D6712909436034B7EF6976664275834689988FAD2E2CC15C85036886CF8B21C420EBC82B4D2A29194DAD6EDF6137962",
            "46504C590301030000000098038F1A9CFF469A2075CD2F2D767F21EBBC684276EA216596EFB4FB87E1C7A2A26020E460F3B1D9956C67BF88D1D3D33CB55D1DF39D6CD71726D36EBD47BE418BA614B9830F932224DAC6F6BCB513D6F65EC1C02C0CD3EFA646BA53546F714850A3B04311EBD0C47F936A43D2BDA3809B28DCA5D3FD58B1F0D490C7742863C6781F65F8BFB5FE719114008D3E7CFED20CBD95638A9ADBBB56"
        };

        static readonly string[] Response2 =
        {
            "46504C5903010400000000146CF8B21C420EBC82B4D2A29194DAD6EDF6137962",
            "46504C590301040000000014B5FE719114008D3E7CFED20CBD95638A9ADBBB56"
        };

        static readonly string[] FPKey =
        {
            "46504C59010201000000003C000000008368F927661A8E303D43CA4956085188000000108B3B9FF7E536D5A18FD57DAC3FF8B2877F1EB2ED6A553FEAD9AF6C42CF2FDD2D29C81C94",
            "46504C59010201000000003C0000000027940137CC465F88E8FB3735C19E83090000001095C7FD62EFF4DE647C2CE15430207845EED754B04C28F5897785C2F0E226DE07B4687CA8"
        };

        static readonly string[] AesKey =
        {
            "98AF82B6219272635D71D582609D1877",
            "3A850F901356C96871D73C4C8E933A06"
        };

        [TestMethod]
        public void SapChallenge()
        {
            for (int i = 0; i < Challenge1.Length; i++)
            {
                SapHandler sap = new SapHandler();
                sap.Init();

                byte[] response1 = sap.Challenge(Challenge1[i].BytesFromHexString(), 0);
                Assert.AreEqual(Response1[i], response1.HexStringFromBytes());

                byte[] response2 = sap.Challenge(Challenge2[i].BytesFromHexString(), 1);
                Assert.AreEqual(Response2[i], response2.HexStringFromBytes());

                byte[] aesKey = sap.DecryptKey(FPKey[i].BytesFromHexString());
                Assert.AreEqual(AesKey[i], aesKey.HexStringFromBytes());
            }
        }
    }
}
